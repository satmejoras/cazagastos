<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Gestor personal de gastos offline">
    <meta name="theme-color" content="#007aff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Mi Econom√≠a">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon e iconos -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <title>üí∞ Mi Econom√≠a</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f7;
            padding: 20px;
            max-width: 400px;
            margin: 0 auto;
            color: #1d1d1f;
            min-height: 100vh;
        }
        
        .tarjeta {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: relative;
        }
        
        h1 { font-size: 24px; margin-bottom: 5px; }
        h2 { font-size: 18px; margin: 20px 0 10px; color: #1d1d1f; }
        .subtitulo { color: #8e8e93; font-size: 14px; margin-bottom: 20px; }
        
        /* Secciones del dashboard */
        .seccion-tipo {
            margin-bottom: 25px;
        }
        
        .encabezado-seccion {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .titulo-seccion {
            font-size: 17px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .estado-presupuesto {
            font-size: 14px;
            color: #8e8e93;
        }
        
        /* Barras de progreso */
        .contenedor-progreso {
            height: 8px;
            background: #e5e5ea;
            border-radius: 4px;
            margin: 10px 0 15px;
            overflow: hidden;
        }
        
        .barra-progreso {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .necesidad .barra-progreso { background: #34c759; } /* Verde */
        .personal .barra-progreso { background: #007aff; } /* Azul */
        
        /* Detalles por categor√≠a */
        .lista-categorias {
            margin-top: 15px;
        }
        
        .categoria-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        .categoria-item:last-child { border-bottom: none; }
        
        .nombre-categoria {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .importe-categoria {
            font-weight: 600;
        }
        
        /* Resumen general */
        .resumen-general {
            text-align: center;
            padding: 20px 0;
            border-top: 1px solid #f0f0f0;
            margin-top: 20px;
        }
        
        .saldo-total {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .positivo { color: #34c759; }
        .negativo { color: #ff3b30; }
        
        /* Botones */
        .boton {
            display: block;
            width: 100%;
            padding: 16px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
            text-decoration: none;
        }
        
        .boton:active { opacity: 0.8; }
        
        .boton-secundario {
            background: transparent;
            color: #007aff;
            border: 2px solid #e5e5ea;
        }
        
        /* Pantallas */
        .pantalla { display: none; }
        .activa { display: block; animation: aparecer 0.3s ease; }
        
        @keyframes aparecer {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Calculadora */
        .teclado {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .tecla {
            padding: 20px 10px;
            background: #f2f2f7;
            border: none;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            /* Prevenir doble-tap y eventos duplicados en m√≥vil */
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .tecla:active {
            opacity: 0.7;
            transform: scale(0.95);
        }
        
        .tecla-borrar {
            background: #ff3b30;
            color: white;
            font-size: 18px;
            grid-column: span 3;
        }
        
        /* Selector de categor√≠as en captura */
        .selector-categorias {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 15px 0;
        }
        
        .categoria-btn {
            padding: 12px 5px;
            border: 2px solid #e5e5ea;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .categoria-btn.seleccionada {
            border-color: #007aff;
            background: rgba(0, 122, 255, 0.1);
            transform: translateY(-2px);
        }
        
        /* Selector de fecha */
        .selector-fecha {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e5e5ea;
        }
        
        .fecha-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .fecha-display {
            font-size: 14px;
            color: #1d1d1f;
        }
        
        .btn-cambiar-fecha {
            background: #007aff;
            border: none;
            color: white;
            font-size: 13px;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .input-fecha-exacta {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e5ea;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .input-fecha-exacta.visible {
            display: block;
        }
        
        /* Bot√≥n info */
        .btn-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 20px;
            color: #8e8e93;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .btn-info:active {
            background: rgba(0,0,0,0.05);
        }
        
        /* Modal info */
        .modal-fondo {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-fondo.activo {
            display: flex;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Notificaciones */
        .notificacion {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #34c759;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            animation: deslizar 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        @keyframes deslizar {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Tabla de detalles en modal */
        .tabla-categorias {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .tabla-categorias th {
            text-align: left;
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 2px solid #e5e5ea;
        }
        
        .tabla-categorias td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .tipo-necesidad { color: #34c759; font-weight: 500; }
        .tipo-personal { color: #007aff; font-weight: 500; }
    </style>
</head>
<body>
    <!-- PANTALLA DE BIENVENIDA -->
    <div id="bienvenida" class="pantalla">
        <div class="tarjeta">
            <h1>üí∞ Mi Econom√≠a</h1>
            <p class="subtitulo">Progressive Web App (PWA) - 100% en tu dispositivo</p>
            
            <!-- Disclaimer -->
            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; border-radius: 10px; margin: 25px 0;">
                <h3 style="color: #856404; font-size: 18px; margin-bottom: 10px;">‚ö†Ô∏è AVISO LEGAL</h3>
                <p style="font-size: 14px; color: #856404; line-height: 1.6;">
                    Esta herramienta es de <strong>uso personal</strong>. El usuario es el √∫nico 
                    responsable del uso de la aplicaci√≥n y de los datos que registre. 
                    No nos hacemos responsables de p√©rdidas de informaci√≥n o 
                    cualquier consecuencia derivada de su uso.
                </p>
            </div>
            
            <!-- Info PWA -->
            <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 20px; border-radius: 10px; margin: 25px 0;">
                <h3 style="color: #1565c0; font-size: 18px; margin-bottom: 10px;">üí° ¬øQu√© es una PWA?</h3>
                <p style="font-size: 14px; color: #1565c0; line-height: 1.6;">
                    Esta aplicaci√≥n funciona <strong>100% en tu dispositivo</strong>. Tus datos nunca 
                    salen de tu m√≥vil/PC. Se actualiza autom√°ticamente cuando hay internet, 
                    pero funciona perfectamente offline.
                </p>
            </div>
            
            <!-- Detectar si est√° instalado -->
            <div id="mensajeInstalacion" style="display: none;">
                <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #c62828; font-size: 16px; margin-bottom: 10px;">üì≤ Debes instalar esta PWA</h3>
                    <p style="font-size: 14px; color: #c62828; line-height: 1.6;">
                        Esta app est√° dise√±ada para funcionar <strong>instalada en tu dispositivo</strong>, 
                        no desde el navegador. Sigue las instrucciones seg√∫n tu dispositivo:
                    </p>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <h4 style="font-size: 15px; margin-bottom: 10px;">üì± En iPhone/iPad:</h4>
                    <ol style="font-size: 14px; color: #424245; line-height: 1.8; margin-left: 20px;">
                        <li>Toca el bot√≥n "Compartir" üì§</li>
                        <li>Selecciona "A√±adir a pantalla de inicio"</li>
                        <li>¬°Listo! √ösala como cualquier app</li>
                    </ol>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <h4 style="font-size: 15px; margin-bottom: 10px;">ü§ñ En Android:</h4>
                    <ol style="font-size: 14px; color: #424245; line-height: 1.8; margin-left: 20px;">
                        <li>Toca el men√∫ (‚ãÆ) en Chrome</li>
                        <li>Selecciona "A√±adir a pantalla de inicio"</li>
                        <li>¬°Listo!</li>
                    </ol>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <h4 style="font-size: 15px; margin-bottom: 10px;">üíª En PC (Chrome/Edge):</h4>
                    <ol style="font-size: 14px; color: #424245; line-height: 1.8; margin-left: 20px;">
                        <li>Busca el icono "Instalar" ‚ûï en la barra de direcciones</li>
                        <li>Click en "Instalar"</li>
                        <li>Se abre como ventana independiente</li>
                    </ol>
                </div>
            </div>
            
            <button class="boton" onclick="aceptarYContinuar()" id="btnAceptar">‚úÖ Acepto y continuar</button>
        </div>
    </div>
    
    <!-- DASHBOARD -->
    <div id="dashboard" class="pantalla activa">
        <div class="tarjeta">
            <button class="btn-info" onclick="mostrarModalInfo()" title="Gu√≠a de categor√≠as y m√©todo">
                ‚ìò
            </button>
            <button class="btn-info" onclick="mostrarConfig()" title="Configuraci√≥n" style="right: 50px;">
                ‚öôÔ∏è
            </button>
            <h1>üí∞ Mi Econom√≠a</h1>
            <div class="subtitulo" id="saludo">Cargando...</div>
            
            <!-- SECCI√ìN NECESIDADES (50%) -->
            <div class="seccion-tipo necesidad">
                <div class="encabezado-seccion">
                    <div class="titulo-seccion">
                        <span>üè†</span>
                        <span>Necesidades (50%)</span>
                    </div>
                    <div class="estado-presupuesto" id="estadoNecesidades">
                        --.--‚Ç¨ / --.--‚Ç¨
                    </div>
                </div>
                
                <div class="contenedor-progreso">
                    <div class="barra-progreso" id="barraNecesidades" style="width: 0%"></div>
                </div>
                
                <div class="lista-categorias" id="listaNecesidades">
                    <!-- Se llena con JavaScript -->
                </div>
            </div>
            
            <!-- SECCI√ìN GASTOS PERSONALES (30%) -->
            <div class="seccion-tipo personal">
                <div class="encabezado-seccion">
                    <div class="titulo-seccion">
                        <span>üéØ</span>
                        <span>Gastos Personales (30%)</span>
                    </div>
                    <div class="estado-presupuesto" id="estadoPersonales">
                        --.--‚Ç¨ / --.--‚Ç¨
                    </div>
                </div>
                
                <div class="contenedor-progreso">
                    <div class="barra-progreso" id="barraPersonales" style="width: 0%"></div>
                </div>
                
                <div class="lista-categorias" id="listaPersonales">
                    <!-- Se llena con JavaScript -->
                </div>
            </div>
            
            <!-- RESUMEN GENERAL -->
            <div class="resumen-general">
                <div style="color: #8e8e93; font-size: 14px;">Saldo disponible este mes</div>
                <div class="saldo-total" id="saldoTotal">--.--‚Ç¨</div>
                <div style="color: #8e8e93; font-size: 13px;" id="infoResumen">
                    De --.--‚Ç¨ ingresados
                </div>
            </div>
            
            <button class="boton" onclick="mostrarCaptura()">‚ûï Nuevo gasto</button>
            <button class="boton boton-secundario" onclick="exportarDatos()" id="btnExportar">üì§ Exportar CSV</button>
        </div>
        
        <!-- √öLTIMOS GASTOS -->
        <div class="tarjeta">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">üìù √öltimos gastos</h2>
                <span id="contadorGastos" style="font-size: 14px; color: #8e8e93;"></span>
            </div>
            <div id="listaGastos">
                <div class="categoria-item">
                    <span style="color: #8e8e93;">No hay gastos a√∫n</span>
                </div>
            </div>
            <button id="btnVerTodos" class="boton boton-secundario" onclick="toggleVerTodos()" style="display: none; margin-top: 15px;">
                üîç Ver todos los gastos
            </button>
        </div>
    </div>
    
    <!-- CONFIGURACI√ìN -->
    <div id="config" class="pantalla">
        <div class="tarjeta">
            <h1>‚öôÔ∏è Configuraci√≥n</h1>
            <p style="margin-bottom: 20px; color: #8e8e93;">Datos b√°sicos para empezar</p>
            
            <input type="text" id="nombre" placeholder="Tu nombre" style="width: 100%; padding: 16px; border: 2px solid #e5e5ea; border-radius: 12px; margin-bottom: 15px;">
            
            <input type="number" id="ingreso" placeholder="Ingreso mensual (‚Ç¨)" style="width: 100%; padding: 16px; border: 2px solid #e5e5ea; border-radius: 12px; margin-bottom: 20px;">
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #007aff;">
                <div style="font-weight: 600; margin-bottom: 10px; color: #007aff;">
                    üìä Se aplicar√° la Regla 50/30/20
                </div>
                <div style="font-size: 14px; color: #424245; line-height: 1.5;">
                    <div><strong style="color: #34c759;">50% Necesidades</strong>: Vivienda, servicios, alimentaci√≥n b√°sica...</div>
                    <div><strong style="color: #007aff;">30% Gastos personales</strong>: Ocio, comer fuera, compras...</div>
                    <div><strong style="color: #ff9500;">20% Ahorro</strong>: Inversiones, fondo emergencia...</div>
                </div>
            </div>
            
            <button class="boton" onclick="guardarConfig()">üíæ Guardar configuraci√≥n</button>
            <button class="boton boton-secundario" onclick="mostrarDashboard()">‚Üê Cancelar</button>
            
            <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                <button class="boton" style="background: #ff3b30;" onclick="borrarTodosLosDatos()">üóëÔ∏è Borrar todos los datos</button>
                <p style="font-size: 12px; color: #8e8e93; text-align: center; margin-top: 10px;">
                    Elimina todos los gastos registrados. Esta acci√≥n no se puede deshacer.
                </p>
            </div>
        </div>
    </div>
    
    <!-- CAPTURA DE GASTOS -->
    <div id="captura" class="pantalla">
        <div class="tarjeta">
            <h1>‚ûï Nuevo gasto</h1>
            
            <!-- 1. CATEGOR√çA PRIMERO -->
            <h3 style="margin: 20px 0 10px;">üè∑Ô∏è Categor√≠a</h3>
            <div class="selector-categorias" id="selectorCategorias">
                <!-- Categor√≠as se cargan con JS -->
            </div>
            
            <!-- 2. IMPORTE -->
            <div class="saldo-total" id="displayImporte" style="font-size: 48px; margin-top: 20px;">0.00‚Ç¨</div>
            
            <div class="teclado">
                <button class="tecla" onpointerdown="event.preventDefault(); agregarNumero('1')">1</button>
                <button class="tecla" onpointerdown="event.preventDefault(); agregarNumero('2')">2</button>
                <button class="tecla" onpointerdown="event.preventDefault(); agregarNumero('3')">3</button>
                <button class="tecla" onpointerdown="event.preventDefault(); agregarNumero('4')">4</button>
                <button class="tecla" onpointerdown="event.preventDefault(); agregarNumero('5')">5</button>
                <button class="tecla" onpointerdown="event.preventDefault(); agregarNumero('6')">6</button>
                <button class="tecla" onpointerdown="event.preventDefault(); agregarNumero('7')">7</button>
                <button class="tecla" onpointerdown="event.preventDefault(); agregarNumero('8')">8</button>
                <button class="tecla" onpointerdown="event.preventDefault(); agregarNumero('9')">9</button>
                <button class="tecla" onpointerdown="event.preventDefault(); agregarNumero('.')">.</button>
                <button class="tecla" onpointerdown="event.preventDefault(); agregarNumero('0')">0</button>
                <button class="tecla tecla-borrar" onpointerdown="event.preventDefault(); borrarNumero()">‚å´ Borrar</button>
            </div>
            
            <!-- 3. DESCRIPCI√ìN -->
            <input type="text" id="descripcion" placeholder="Descripci√≥n (opcional): Ej. Mercadona, Gasolina BP..." style="width: 100%; padding: 16px; border: 2px solid #e5e5ea; border-radius: 12px; margin: 15px 0;">
            
            <!-- 4. FECHA AL FINAL -->
            <div class="selector-fecha">
                <div class="fecha-header">
                    <div class="fecha-display">
                        üìÖ Fecha: <strong id="fechaDisplay">Hoy</strong>
                    </div>
                    <button type="button" class="btn-cambiar-fecha" onclick="mostrarCalendario()">
                        üìÖ Cambiar
                    </button>
                </div>
                
                <div id="calendarioContainer" style="display: none; margin-top: 10px;">
                    <input type="date" id="fechaExacta" class="input-fecha-exacta">
                    <button type="button" class="boton" style="margin-top: 10px; padding: 12px; font-size: 15px;" onclick="confirmarFecha()">
                        ‚úì Confirmar fecha
                    </button>
                </div>
            </div>
            
            <button class="boton" onclick="guardarGasto()">üíæ Guardar gasto</button>
            <button class="boton boton-secundario" onclick="mostrarDashboard()">‚Üê Cancelar</button>
        </div>
    </div>
    
    <!-- MODAL INFO (Gu√≠a completa) -->
    <div id="modalInfo" class="modal-fondo" onclick="ocultarModalInfo()">
        <div class="tarjeta" style="max-width: 400px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
            <h1>üìä Gu√≠a completa</h1>
            
            <!-- Regla 50/30/20 -->
            <div style="margin: 25px 0;">
                <h3>üéØ Regla 50/30/20</h3>
                <div style="background: #34c759; color: white; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                    <div style="font-size: 20px; font-weight: 700;">50% Necesidades</div>
                    <div style="font-size: 14px; margin-top: 8px;">
                        Gastos esenciales para vivir. Suelen ser fijos o poco variables.
                    </div>
                </div>
                
                <div style="background: #007aff; color: white; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                    <div style="font-size: 20px; font-weight: 700;">30% Gastos personales</div>
                    <div style="font-size: 14px; margin-top: 8px;">
                        Gastos discrecionales que mejoran tu calidad de vida.
                    </div>
                </div>
                
                <div style="background: #ff9500; color: white; padding: 15px; border-radius: 10px;">
                    <div style="font-size: 20px; font-weight: 700;">20% Ahorro e inversi√≥n</div>
                    <div style="font-size: 14px; margin-top: 8px;">
                        Para tu futuro financiero y fondo de emergencia.
                    </div>
                </div>
            </div>
            
            <!-- Tabla de categor√≠as -->
            <h3>üìã Categor√≠as detalladas</h3>
            <table class="tabla-categorias">
                <thead>
                    <tr>
                        <th>Categor√≠a</th>
                        <th>Tipo</th>
                        <th>Ejemplos incluidos</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>üè† Vivienda</td>
                        <td class="tipo-necesidad">Necesidad</td>
                        <td>Alquiler, hipoteca, comunidad, IBI</td>
                    </tr>
                    <tr>
                        <td>üí° Servicios</td>
                        <td class="tipo-necesidad">Necesidad</td>
                        <td>Luz, agua, gas, calefacci√≥n, basura</td>
                    </tr>
                    <tr>
                        <td>üõí Alimentaci√≥n</td>
                        <td class="tipo-necesidad">Necesidad</td>
                        <td>Supermercado, farmacia b√°sica</td>
                    </tr>
                    <tr>
                        <td>üöó Transporte</td>
                        <td class="tipo-necesidad">Necesidad</td>
                        <td>Gasolina, parking, transporte p√∫blico, ITV</td>
                    </tr>
                    <tr>
                        <td>üè• Salud</td>
                        <td class="tipo-necesidad">Necesidad</td>
                        <td>M√©dico, dentista, veterinario, medicinas</td>
                    </tr>
                    <tr>
                        <td>üõ°Ô∏è Seguros</td>
                        <td class="tipo-necesidad">Necesidad</td>
                        <td>Coche, hogar, salud, vida</td>
                    </tr>
                    <tr>
                        <td>üçΩÔ∏è Comer fuera</td>
                        <td class="tipo-personal">Personal</td>
                        <td>Restaurantes, bares, delivery, caf√©s</td>
                    </tr>
                    <tr>
                        <td>üéâ Ocio</td>
                        <td class="tipo-personal">Personal</td>
                        <td>Cine, streaming, vacaciones, gym, hobbies</td>
                    </tr>
                    <tr>
                        <td>üõçÔ∏è Compras</td>
                        <td class="tipo-personal">Personal</td>
                        <td>Ropa, tecnolog√≠a, decoraci√≥n, caprichos</td>
                    </tr>
                    <tr>
                        <td>üìö Formaci√≥n</td>
                        <td class="tipo-personal">Personal</td>
                        <td>Cursos, libros, conferencias, desarrollo</td>
                    </tr>
                    <tr>
                        <td>üéÅ Regalos</td>
                        <td class="tipo-personal">Personal</td>
                        <td>Cumplea√±os, aniversarios, donaciones</td>
                    </tr>
                    <tr>
                        <td>üîß Mantenimiento</td>
                        <td class="tipo-personal">Personal</td>
                        <td>Reparaciones, talleres, reformas hogar</td>
                </tbody>
            </table>
            
            <!-- C√≥mo decidir -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0;">
                <h4>üí° ¬øD√≥nde registro mi gasto?</h4>
                <p style="font-size: 14px; color: #424245; margin-top: 5px;">
                    <strong>Pregunta:</strong> ¬øEs esencial para vivir o mantener mi hogar/salud?<br>
                    <strong>Si S√ç ‚Üí</strong> Necesidad (50%)<br>
                    <strong>Si NO ‚Üí</strong> Personal (30%)<br><br>
                    Ej: Gasolina para ir a trabajar ‚Üí üöó Transporte (Necesidad)<br>
                    Ej: Gasolina para viaje vacaciones ‚Üí üéâ Ocio (Personal)
                </p>
            </div>
            
            <!-- Secci√≥n de cr√©ditos -->
            <div style="border-top: 2px solid #e5e5ea; padding-top: 20px; margin-top: 30px;">
                <h4 style="font-size: 15px; color: #8e8e93; margin-bottom: 10px;">‚ÑπÔ∏è Acerca de</h4>
                <div style="font-size: 13px; color: #6c757d; line-height: 1.6;">
                    <div style="margin-bottom: 5px;"><strong>üí∞ Mi Econom√≠a</strong> v1.0</div>
                    <div style="margin-bottom: 5px;">‚ú® Esta maravilla ha sido posible gracias a un cerebro humano cocreando con IA</div>
                    <div style="color: #8e8e93;">üìÖ Febrero 2026</div>
                </div>
            </div>
            
            <button class="boton" onclick="ocultarModalInfo()">
                ‚úÖ Entendido, ¬°a registrar!
            </button>
        </div>
    </div>

    <script>
        // ========== DATOS Y CONFIGURACI√ìN ==========
        let datos = {
            configurado: false,
            vistoBienvenida: false,
            usuario: { nombre: '', ingreso: 0 },
            gastos: []
        };
        
        // CATEGOR√çAS EST√ÅNDAR (12)
        const categorias = [
            // üè† NECESIDADES (50%)
            { id: 'vivienda', nombre: 'üè† Vivienda', tipo: 'necesidad' },
            { id: 'servicios', nombre: 'üí° Servicios', tipo: 'necesidad' },
            { id: 'alimentacion', nombre: 'üõí Alimentaci√≥n', tipo: 'necesidad' },
            { id: 'transporte', nombre: 'üöó Transporte', tipo: 'necesidad' },
            { id: 'salud', nombre: 'üè• Salud', tipo: 'necesidad' },
            { id: 'seguros', nombre: 'üõ°Ô∏è Seguros', tipo: 'necesidad' },
            
            // üéØ PERSONALES (30%)
            { id: 'comer_fuera', nombre: 'üçΩÔ∏è Comer fuera', tipo: 'personal' },
            { id: 'ocio', nombre: 'üéâ Ocio', tipo: 'personal' },
            { id: 'compras', nombre: 'üõçÔ∏è Compras', tipo: 'personal' },
            { id: 'formacion', nombre: 'üìö Formaci√≥n', tipo: 'personal' },
            { id: 'regalos', nombre: 'üéÅ Regalos', tipo: 'personal' },
            { id: 'mantenimiento', nombre: 'üîß Mantenimiento', tipo: 'personal' }
        ];
        
        // ========== GESTI√ìN DE FECHA ==========
        let fechaSeleccionada = null; // null = hoy
        
        function formatearFecha(date) {
            const hoy = new Date();
            const ayer = new Date(hoy);
            ayer.setDate(ayer.getDate() - 1);
            const anteayer = new Date(hoy);
            anteayer.setDate(anteayer.getDate() - 2);
            
            // Comparar fechas
            if (date.toDateString() === hoy.toDateString()) {
                return "Hoy";
            } else if (date.toDateString() === ayer.toDateString()) {
                return "Ayer";
            } else if (date.toDateString() === anteayer.toDateString()) {
                return "Anteayer";
            } else {
                return date.toLocaleDateString('es-ES', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short'
                });
            }
        }
        
        function mostrarCalendario() {
            const container = document.getElementById('calendarioContainer');
            const isVisible = container.style.display !== 'none';
            
            if (isVisible) {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
                // Configurar el input
                const hoy = new Date();
                const inputFecha = document.getElementById('fechaExacta');
                inputFecha.min = '2020-01-01';
                inputFecha.max = hoy.toISOString().split('T')[0];
                
                // Pre-seleccionar la fecha actual o la ya seleccionada
                if (fechaSeleccionada) {
                    inputFecha.value = fechaSeleccionada.toISOString().split('T')[0];
                } else {
                    inputFecha.value = hoy.toISOString().split('T')[0];
                }
                
                // Focus en el input para abrir el picker nativo en m√≥vil
                setTimeout(() => {
                    inputFecha.focus();
                }, 100);
            }
        }
        

        function confirmarFecha() {
            const inputFecha = document.getElementById('fechaExacta');
            const valor = inputFecha.value;
            
            if (valor) {
                fechaSeleccionada = new Date(valor + 'T12:00:00'); // Evitar problemas de zona horaria
                actualizarDisplayFecha();
                document.getElementById('calendarioContainer').style.display = 'none';
            } else {
                // Si no seleccion√≥ nada, mantener como "Hoy"
                fechaSeleccionada = null;
                actualizarDisplayFecha();
                document.getElementById('calendarioContainer').style.display = 'none';
            }
        }
        
        function actualizarDisplayFecha() {
            const display = document.getElementById('fechaDisplay');
            if (fechaSeleccionada === null) {
                display.textContent = "Hoy";
            } else {
                display.textContent = formatearFecha(fechaSeleccionada);
            }
        }
        
        function obtenerFechaParaGuardar() {
            if (fechaSeleccionada === null) {
                return new Date(); // Hoy
            } else {
                // Mantener la hora actual pero con la fecha seleccionada
                const ahora = new Date();
                const fecha = new Date(fechaSeleccionada);
                fecha.setHours(ahora.getHours(), ahora.getMinutes(), ahora.getSeconds());
                return fecha;
            }
        }
        
        // ========== FUNCIONES GENERALES ==========
        function cargarDatos() {
            const guardados = localStorage.getItem('finanzas_50_30_20');
            if (guardados) {
                datos = JSON.parse(guardados);
            }
        }
        
        function guardarDatos() {
            localStorage.setItem('finanzas_50_30_20', JSON.stringify(datos));
        }
        
        function mostrarNotificacion(mensaje) {
            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion';
            notificacion.textContent = mensaje;
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.style.animation = 'deslizar 0.3s ease reverse';
                setTimeout(() => notificacion.remove(), 300);
            }, 2000);
        }
        
        // ========== INTERFAZ Y NAVEGACI√ìN ==========
        function mostrarPantalla(id) {
            document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
            document.getElementById(id).classList.add('activa');
            
            if (id === 'dashboard') {
                actualizarDashboard();
            } else if (id === 'captura') {
                inicializarCaptura();
            } else if (id === 'config') {
                document.getElementById('nombre').value = datos.usuario.nombre || '';
                document.getElementById('ingreso').value = datos.usuario.ingreso || '';
            }
        }
        
        function mostrarDashboard() { mostrarPantalla('dashboard'); }
        function mostrarConfig() { mostrarPantalla('config'); }
        function mostrarCaptura() { mostrarPantalla('captura'); }
        function mostrarModalInfo() { document.getElementById('modalInfo').classList.add('activo'); }
        function ocultarModalInfo() { document.getElementById('modalInfo').classList.remove('activo'); }
        
        // ========== BIENVENIDA ==========
        function mostrarBienvenida() {
            mostrarPantalla('bienvenida');
            
            // Detectar si est√° instalado como PWA
            const esInstalado = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone === true;
            
            if (!esInstalado) {
                // No est√° instalado, mostrar instrucciones obligatorias
                document.getElementById('mensajeInstalacion').style.display = 'block';
                document.getElementById('btnAceptar').textContent = '‚úÖ He instalado la app';
            } else {
                // Ya est√° instalado, solo mostrar disclaimer
                document.getElementById('mensajeInstalacion').style.display = 'none';
                document.getElementById('btnAceptar').textContent = '‚úÖ Acepto y continuar';
            }
        }
        
        function aceptarYContinuar() {
            datos.vistoBienvenida = true;
            guardarDatos();
            
            if (!datos.configurado) {
                mostrarConfig();
            } else {
                mostrarDashboard();
            }
        }
        
        // ========== CONFIGURACI√ìN ==========
        function guardarConfig() {
            const nombre = document.getElementById('nombre').value.trim();
            const ingreso = parseFloat(document.getElementById('ingreso').value);
            
            if (!nombre || !ingreso || ingreso < 100) {
                mostrarNotificacion('Completa los campos correctamente');
                return;
            }
            
            datos.configurado = true;
            datos.usuario = { nombre, ingreso };
            guardarDatos();
            
            mostrarNotificacion(`‚úÖ Configurado para ${nombre}`);
            mostrarDashboard();
        }
        
        function borrarTodosLosDatos() {
            const totalGastos = datos.gastos ? datos.gastos.length : 0;
            
            if (totalGastos === 0) {
                mostrarNotificacion('No hay datos para borrar');
                return;
            }
            
            const confirmar = confirm(
                `‚ö†Ô∏è ¬øEst√°s seguro?\n\nEsto borrar√° ${totalGastos} gasto${totalGastos > 1 ? 's' : ''} registrado${totalGastos > 1 ? 's' : ''}.\n\nEsta acci√≥n no se puede deshacer.`
            );
            
            if (confirmar) {
                datos.gastos = [];
                guardarDatos();
                mostrarNotificacion('üóëÔ∏è Todos los datos han sido borrados');
                setTimeout(() => {
                    mostrarDashboard();
                }, 1000);
            }
        }
        
        // ========== DASHBOARD (C√ÅLCULOS COMPLETOS) ==========
        function actualizarDashboard() {
            if (!datos.configurado) {
                mostrarConfig();
                return;
            }
            
            // Saludo
            document.getElementById('saludo').textContent = `Hola ${datos.usuario.nombre}`;
            
            // Presupuestos mensuales
            const presupuestoNecesidades = datos.usuario.ingreso * 0.50;
            const presupuestoPersonales = datos.usuario.ingreso * 0.30;
            const presupuestoTotalGastos = presupuestoNecesidades + presupuestoPersonales;
            
            // Fecha actual para c√°lculos mensuales
            const hoy = new Date();
            const a√±o = hoy.getFullYear();
            const mes = hoy.getMonth();
            const diaMes = hoy.getDate();
            const diasTotales = new Date(a√±o, mes + 1, 0).getDate();
            
            // Calcular gastos del mes actual por tipo
            const inicioMes = new Date(a√±o, mes, 1);
            const finMes = new Date(a√±o, mes + 1, 0);
            const gastosEsteMes = datos.gastos.filter(g => {
                if (!g.fecha) return false;
                const fechaGasto = new Date(g.fecha);
                return fechaGasto >= inicioMes && fechaGasto <= finMes;
            });
            
            // Agrupar por categor√≠a y tipo
            const gastosPorCategoria = {};
            let totalNecesidades = 0;
            let totalPersonales = 0;
            
            gastosEsteMes.forEach(gasto => {
                const categoria = categorias.find(c => c.id === gasto.categoria);
                if (!categoria) return;
                
                if (!gastosPorCategoria[categoria.id]) {
                    gastosPorCategoria[categoria.id] = 0;
                }
                gastosPorCategoria[categoria.id] += gasto.importe;
                
                if (categoria.tipo === 'necesidad') {
                    totalNecesidades += gasto.importe;
                } else if (categoria.tipo === 'personal') {
                    totalPersonales += gasto.importe;
                }
            });
            
            const totalGastado = totalNecesidades + totalPersonales;
            const saldoDisponible = presupuestoTotalGastos - totalGastado;
            
            // ===== ACTUALIZAR INTERFAZ =====
            
            // 1. NECESIDADES (50%)
            const porcentajeNecesidades = Math.min((totalNecesidades / presupuestoNecesidades) * 100, 100);
            document.getElementById('barraNecesidades').style.width = `${porcentajeNecesidades}%`;
            document.getElementById('estadoNecesidades').textContent = 
                `${totalNecesidades.toFixed(2)}‚Ç¨ / ${presupuestoNecesidades.toFixed(2)}‚Ç¨`;
            
            // Lista de categor√≠as de necesidades
            let htmlNecesidades = '';
            categorias
                .filter(c => c.tipo === 'necesidad')
                .forEach(cat => {
                    const gasto = gastosPorCategoria[cat.id] || 0;
                    if (gasto > 0) {
                        htmlNecesidades += `
                            <div class="categoria-item">
                                <div class="nombre-categoria">
                                    <span>${cat.nombre.split(' ')[0]}</span>
                                    <span>${cat.nombre.split(' ').slice(1).join(' ')}</span>
                                </div>
                                <div class="importe-categoria">${gasto.toFixed(2)}‚Ç¨</div>
                            </div>
                        `;
                    }
                });
            
            if (htmlNecesidades === '') {
                htmlNecesidades = '<div class="categoria-item"><span style="color: #8e8e93;">Sin gastos a√∫n</span></div>';
            }
            document.getElementById('listaNecesidades').innerHTML = htmlNecesidades;
            
            // 2. GASTOS PERSONALES (30%)
            const porcentajePersonales = Math.min((totalPersonales / presupuestoPersonales) * 100, 100);
            document.getElementById('barraPersonales').style.width = `${porcentajePersonales}%`;
            document.getElementById('estadoPersonales').textContent = 
                `${totalPersonales.toFixed(2)}‚Ç¨ / ${presupuestoPersonales.toFixed(2)}‚Ç¨`;
            
            // Lista de categor√≠as personales
            let htmlPersonales = '';
            categorias
                .filter(c => c.tipo === 'personal')
                .forEach(cat => {
                    const gasto = gastosPorCategoria[cat.id] || 0;
                    if (gasto > 0) {
                        htmlPersonales += `
                            <div class="categoria-item">
                                <div class="nombre-categoria">
                                    <span>${cat.nombre.split(' ')[0]}</span>
                                    <span>${cat.nombre.split(' ').slice(1).join(' ')}</span>
                                </div>
                                <div class="importe-categoria">${gasto.toFixed(2)}‚Ç¨</div>
                            </div>
                        `;
                    }
                });
            
            if (htmlPersonales === '') {
                htmlPersonales = '<div class="categoria-item"><span style="color: #8e8e93;">Sin gastos a√∫n</span></div>';
            }
            document.getElementById('listaPersonales').innerHTML = htmlPersonales;
            
            // 3. RESUMEN GENERAL
            document.getElementById('saldoTotal').textContent = `${saldoDisponible.toFixed(2)}‚Ç¨`;
            document.getElementById('saldoTotal').className = saldoDisponible >= 0 ? 'saldo-total positivo' : 'saldo-total negativo';
            
            document.getElementById('infoResumen').innerHTML = `
                De ${datos.usuario.ingreso.toFixed(2)}‚Ç¨ ingresados ‚Ä¢ 
                D√≠a ${diaMes}/${diasTotales} ‚Ä¢ 
                <strong>${totalGastado.toFixed(2)}‚Ç¨</strong> gastados
            `;
            
            // 4. √öLTIMOS GASTOS (independiente del tipo)
            actualizarUltimosGastos();
            
            // 5. ACTUALIZAR BOT√ìN EXPORTAR con n√∫mero de gastos
            const totalGastos = datos.gastos ? datos.gastos.length : 0;
            const btnExportar = document.getElementById('btnExportar');
            if (totalGastos > 0) {
                btnExportar.textContent = `üì§ Exportar CSV (${totalGastos} gasto${totalGastos > 1 ? 's' : ''})`;
            } else {
                btnExportar.textContent = 'üì§ Exportar CSV';
            }
        }
        
        let mostrandoTodos = false;
        
        function actualizarUltimosGastos() {
            const container = document.getElementById('listaGastos');
            const btnVerTodos = document.getElementById('btnVerTodos');
            const contadorGastos = document.getElementById('contadorGastos');
            
            if (!datos.gastos || datos.gastos.length === 0) {
                container.innerHTML = `
                    <div class="categoria-item">
                        <span style="color: #8e8e93;">No hay gastos registrados a√∫n</span>
                    </div>
                `;
                btnVerTodos.style.display = 'none';
                contadorGastos.textContent = '';
                return;
            }
            
            const totalGastos = datos.gastos.length;
            const gastosOrdenados = [...datos.gastos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            // Determinar cu√°ntos mostrar
            const gastosAMostrar = mostrandoTodos ? gastosOrdenados : gastosOrdenados.slice(0, 5);
            
            // Actualizar contador
            if (totalGastos > 5) {
                contadorGastos.textContent = mostrandoTodos 
                    ? `Mostrando ${totalGastos} gastos` 
                    : `${totalGastos} gastos totales`;
                btnVerTodos.style.display = 'block';
                btnVerTodos.textContent = mostrandoTodos 
                    ? 'üîº Mostrar solo √∫ltimos 5' 
                    : `üîç Ver todos los gastos (${totalGastos})`;
            } else {
                contadorGastos.textContent = `${totalGastos} gasto${totalGastos > 1 ? 's' : ''}`;
                btnVerTodos.style.display = 'none';
            }
            
            // Generar HTML
            let html = '';
            gastosAMostrar.forEach(gasto => {
                const fecha = new Date(gasto.fecha);
                const categoria = categorias.find(c => c.id === gasto.categoria) || categorias[0];
                
                html += `
                    <div class="categoria-item">
                        <div class="nombre-categoria">
                            <span>${categoria.nombre.split(' ')[0]}</span>
                            <span>${gasto.descripcion || categoria.nombre.split(' ').slice(1).join(' ')}</span>
                        </div>
                        <div style="text-align: right;">
                            <div class="importe-categoria">${gasto.importe.toFixed(2)}‚Ç¨</div>
                            <div style="font-size: 11px; color: #8e8e93;">
                                ${fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function toggleVerTodos() {
            mostrandoTodos = !mostrandoTodos;
            actualizarUltimosGastos();
            
            // Scroll suave a la secci√≥n si estamos expandiendo
            if (mostrandoTodos) {
                document.getElementById('listaGastos').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        // ========== CAPTURA DE GASTOS ==========
        let importeActual = '0';
        let categoriaSeleccionada = 'alimentacion';
        
        function obtenerCategoria(id) {
            return categorias.find(c => c.id === id) || categorias[0];
        }
        
        function inicializarCaptura() {
            importeActual = '0';
            categoriaSeleccionada = 'alimentacion';
            fechaSeleccionada = null; // Reset a "Hoy"
            actualizarDisplayFecha();
            actualizarDisplayImporte();
            cargarSelectorCategorias();
            document.getElementById('descripcion').value = '';
            
            // Ocultar calendario
            document.getElementById('calendarioContainer').style.display = 'none';
            
            // Configurar input date con fechas razonables
            const hoy = new Date();
            const inputFecha = document.getElementById('fechaExacta');
            inputFecha.min = '2020-01-01';
            inputFecha.max = hoy.toISOString().split('T')[0];
            inputFecha.value = hoy.toISOString().split('T')[0];
        }
        
        function cargarSelectorCategorias() {
            const container = document.getElementById('selectorCategorias');
            let html = '';
            
            categorias.forEach(cat => {
                const seleccionada = cat.id === categoriaSeleccionada ? 'seleccionada' : '';
                html += `
                    <div class="categoria-btn ${seleccionada}" onclick="seleccionarCategoria('${cat.id}')">
                        ${cat.nombre}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function seleccionarCategoria(id) {
            categoriaSeleccionada = id;
            cargarSelectorCategorias();
        }
        
        function agregarNumero(num) {
            console.log('agregarNumero llamado:', num, 'importeActual antes:', importeActual);
            
            // Evitar entrada duplicada por eventos m√∫ltiples
            if (window.ultimaTecla === num && Date.now() - window.ultimaTeclaTime < 300) {
                console.log('Bloqueado por debounce');
                return;
            }
            window.ultimaTecla = num;
            window.ultimaTeclaTime = Date.now();
            
            // Si es 0 inicial y no es punto, reemplazar
            if (importeActual === '0' && num !== '.') {
                importeActual = num;
            } 
            // No permitir m√°s de un punto decimal
            else if (num === '.' && importeActual.includes('.')) {
                return;
            }
            // No permitir m√°s de 2 decimales
            else if (importeActual.includes('.') && importeActual.split('.')[1].length >= 2) {
                return;
            }
            // L√≠mite de longitud (999999.99)
            else if (importeActual.replace('.', '').length < 8) {
                importeActual += num;
            }
            
            console.log('importeActual despu√©s:', importeActual);
            actualizarDisplayImporte();
        }
        
        function borrarNumero() {
            console.log('borrarNumero llamado, importeActual antes:', importeActual);
            
            // Evitar borrado duplicado por eventos m√∫ltiples
            if (window.ultimaBorrado && Date.now() - window.ultimaBorrado < 300) {
                console.log('Bloqueado por debounce');
                return;
            }
            window.ultimaBorrado = Date.now();
            
            if (importeActual.length > 1) {
                importeActual = importeActual.slice(0, -1);
            } else {
                importeActual = '0';
            }
            
            console.log('importeActual despu√©s:', importeActual);
            actualizarDisplayImporte();
        }
        
        function actualizarDisplayImporte() {
            // Guardar valor antes de procesar
            const valorOriginal = importeActual;
            let display = importeActual;
            
            // Formatear para visualizaci√≥n
            if (!importeActual.includes('.')) {
                // Sin punto decimal, mostrar .00
                display = importeActual + ',00';
            } else {
                const partes = importeActual.split('.');
                if (partes[1].length === 0) {
                    // Tiene punto pero sin decimales: "52."
                    display = partes[0] + ',00';
                } else if (partes[1].length === 1) {
                    // Un decimal: "52.5"
                    display = partes[0] + ',' + partes[1] + '0';
                } else {
                    // Dos decimales: "52.50"
                    display = partes[0] + ',' + partes[1];
                }
            }
            
            document.getElementById('displayImporte').textContent = display + '‚Ç¨';
            
            // Verificar que no se modific√≥ accidentalmente
            if (importeActual !== valorOriginal) {
                console.error('¬°ALERTA! importeActual fue modificado:', valorOriginal, '->', importeActual);
                importeActual = valorOriginal;
            }
        }
        
        function guardarGasto() {
            const importe = parseFloat(importeActual);
            
            if (!importe || importe <= 0) {
                mostrarNotificacion('Introduce un importe v√°lido');
                return;
            }
            
            const fechaGasto = obtenerFechaParaGuardar();
            
            const nuevoGasto = {
                id: Date.now(),
                fecha: fechaGasto.toISOString(),
                importe: importe,
                categoria: categoriaSeleccionada,
                descripcion: document.getElementById('descripcion').value.trim() || ''
            };
            
            datos.gastos.push(nuevoGasto);
            
            // L√çMITE: 1000 gastos m√°ximos
            const MAX_GASTOS = 1000;
            if (datos.gastos.length > MAX_GASTOS) {
                datos.gastos = datos.gastos.slice(-MAX_GASTOS);
            }
            
            guardarDatos();
            
            // Notificaci√≥n y volver autom√°ticamente
            const categoria = obtenerCategoria(categoriaSeleccionada);
            mostrarNotificacion(`‚úÖ ${importe.toFixed(2)}‚Ç¨ en ${categoria.nombre}`);
            
            setTimeout(() => {
                mostrarDashboard();
            }, 800);
        }
        
        // ========== EXPORTACI√ìN ==========
        function exportarDatos() {
            if (!datos.gastos || datos.gastos.length === 0) {
                mostrarNotificacion('No hay datos para exportar');
                return;
            }
            
            // Nombre de archivo personalizado
            const nombreUsuario = datos.usuario.nombre 
                ? datos.usuario.nombre.replace(/\s+/g, '_')
                : 'gastos';
            
            const hoy = new Date();
            const nombreArchivo = `${nombreUsuario}_${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}-${String(hoy.getDate()).padStart(2,'0')}.csv`;
            
            // Crear CSV con punto y coma (separador para Excel en espa√±ol)
            let csv = 'Fecha;Hora;Importe;Categor√≠a;Tipo;Descripci√≥n\n';
            datos.gastos.forEach(gasto => {
                const fecha = new Date(gasto.fecha);
                const categoria = obtenerCategoria(gasto.categoria);
                
                csv += `${fecha.toLocaleDateString('es-ES')};${fecha.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})};${gasto.importe};${categoria.nombre};${categoria.tipo};${gasto.descripcion}\n`;
            });
            
            // Descargar con BOM para UTF-8
            const BOM = '\uFEFF'; // Byte Order Mark para UTF-8
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = nombreArchivo;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarNotificacion(`üì§ Exportados ${datos.gastos.length} gastos`);
        }
        
        // ========== INICIALIZACI√ìN ==========
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatos();
            
            // Mostrar bienvenida si es la primera vez
            if (!datos.vistoBienvenida) {
                mostrarBienvenida();
            } else if (!datos.configurado) {
                mostrarConfig();
            } else {
                mostrarDashboard();
            }
            
            // Evento para ocultar calendario si se hace clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.selector-fecha')) {
                    document.getElementById('calendarioContainer').style.display = 'none';
                }
            });
            
            // Teclado f√≠sico (solo en desktop, no en m√≥vil)
            document.addEventListener('keydown', function(e) {
                // Solo activar si NO estamos en pantalla t√°ctil
                if (!('ontouchstart' in window) && document.getElementById('captura').classList.contains('activa')) {
                    if (e.key >= '0' && e.key <= '9') {
                        e.preventDefault();
                        agregarNumero(e.key);
                    }
                    else if (e.key === '.') {
                        e.preventDefault();
                        agregarNumero('.');
                    }
                    else if (e.key === 'Backspace') {
                        e.preventDefault();
                        borrarNumero();
                    }
                    else if (e.key === 'Enter') {
                        e.preventDefault();
                        guardarGasto();
                    }
                }
            });
            
            // Registrar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/cazagastos/sw.js', { scope: '/cazagastos/' })
                    .then(reg => console.log('Service Worker registrado', reg))
                    .catch(err => console.log('Error al registrar Service Worker', err));
            }
        });
    </script>
</body>
</html>
